# Tankmania 仕様書（調査メモ）

## 調査状況
- 外部サイト（公式サイト、配信ストア、動画、レビュー）へのアクセスがネットワーク制限で拒否されるため、現時点では一次情報の確認ができていない。必要な情報源は以下を想定しており、アクセス可能な環境で再調査が必要。
  - 公式サイト（開発元/パブリッシャー）
  - 配信ストア（App Store / Google Play / Steam など）
  - プレイ動画（YouTube 等）
  - レビュー（ストアレビュー/メディアレビュー）

## 調査で記録する項目（未取得）
> 以下は調査対象の項目であり、現時点では未取得（TBD）。

### 操作方法（TBD）
- 入力デバイス（キーボード/コントローラー/タッチ）
- 移動、射撃、旋回、特殊アクション

### ゲームルール（TBD）
- ゲーム開始条件
- 敵/味方ユニットの概要
- 時間制限/スコア条件

### 勝敗条件（TBD）
- 勝利条件（例: 全敵撃破、拠点防衛、ボス撃破）
- 敗北条件（例: プレイヤー撃破、拠点破壊、タイムアップ）

### ステージ構成（TBD）
- ステージ数/ワールド構成
- 地形やオブジェクトの種類
- 進行方式（固定/ランダム/ループ）

### 敵AI挙動（TBD）
- 行動パターン（巡回/追尾/遠距離/接近）
- 生成条件（スポーン位置/タイミング）
- 連携/特殊行動

## 追加調査/設計メモ（暫定）
> 現時点では一次情報にアクセスできていないため、以下は**暫定の設計仮説**として記録する。実機調査が可能になり次第、差分を確定版に反映する。

### ステージ数・障害物配置ルール・クリア条件（暫定）
- ステージ数: 30 ステージ想定（10 ステージ × 3 エリア）。ワールド進行は固定順で、ステージ選択は不可。※実機確認待ち。  
- 障害物配置ルール: 20x15 タイルの固定グリッドで配置し、障害物は以下の制約で配置する。  
  - 生成禁止セル: プレイヤー初期位置から半径 2 タイル以内、敵スポーン位置から半径 2 タイル以内。  
  - 通路確保: プレイヤー初期位置から「最も近い敵スポーン」まで、幅 2 タイル以上の通路を必ず確保。  
  - 密度上限: 障害物率 18〜28%（タイル総数に対する割合）。  
  - 連結制限: 2x2 以上の完全ブロックを連続で生成しない（視界/射線確保のため）。  
- クリア条件: 「敵全滅」または「拠点防衛タイマー 180s を守り切る」のいずれかをステージ毎に設定。  
- 敗北条件: プレイヤー HP 0 で敗北。拠点防衛ステージでは拠点 HP 0 でも敗北。  

### 敵AIの移動/索敵/射撃ルーチン（暫定モデル）
> 状態遷移ベースでモデル化する。敵タンクは以下の 5 状態を持つ。

1. **巡回（Patrol）**
   - 移動: 目的地ノード（ウェイポイント）を巡回。ノードはステージごとに最大 4 点。  
   - 索敵: 視界半径 8 タイル、視界角 120°。障害物で遮蔽される。  
   - 遷移: プレイヤーを視認 → 「発見」へ。
2. **発見（Acquire）**
   - 行動: 最終視認位置を記録し、砲塔を向けて 0.25s 以内に照準合わせ。  
   - 遷移: 距離 ≤ 6 タイル → 「射撃」へ。視認喪失 → 「追撃」へ。
3. **追撃（Chase）**
   - 移動: 最終視認位置へ最短経路で接近（簡易グリッド BFS を想定）。  
   - 索敵: 視界半径 10 タイルに拡張。  
   - 遷移: 視認復帰 & 距離 ≤ 6 タイル → 「射撃」へ。最終視認位置到達 & 未発見 → 「巡回」へ復帰。
4. **射撃（Engage）**
   - 行動: 砲塔をプレイヤーに合わせ、射撃間隔 0.65s で単発射撃。  
   - 移動: 低速で左右に 1〜2 タイル程度のジグザグ（被弾回避）。  
   - 遷移: 視認喪失 → 「追撃」へ。距離 ≥ 9 タイル → 「追撃」へ。
5. **回避（Evade）**
   - 行動: プレイヤー弾の接近を検知した場合、弾の進行方向から 90° 方向へ 1.5 タイル移動。  
   - 遷移: 回避完了 → 直前の状態へ戻る。

### レベルデータ形式（暫定）とサンプル
> JSON を採用する。理由は「可読性」「差分レビューの容易さ」「タイルグリッドへのマッピングが単純」。

#### JSON スキーマ（簡易）
- `levelId` (number): レベル番号  
- `name` (string): レベル名  
- `size` (object): `width`, `height`  
- `playerSpawn` (object): `{ x, y }`  
- `enemySpawns` (array): `{ x, y, patrolRouteId }`  
- `patrolRoutes` (array): `{ id, waypoints: [{ x, y }] }`  
- `obstacles` (array): `{ x, y, w, h, type }`（type: `wall|water|crate` など）  
- `winCondition` (object): `{ type: "eliminate" | "defend", value }`  
- `loseCondition` (object): `{ type: "playerDown" | "baseDown", value }`  

#### サンプルデータ（JSON）
```json
{
  "levelId": 3,
  "name": "Depot Line",
  "size": { "width": 20, "height": 15 },
  "playerSpawn": { "x": 2, "y": 13 },
  "enemySpawns": [
    { "x": 18, "y": 2, "patrolRouteId": "r1" },
    { "x": 16, "y": 4, "patrolRouteId": "r2" }
  ],
  "patrolRoutes": [
    { "id": "r1", "waypoints": [{ "x": 16, "y": 2 }, { "x": 18, "y": 6 }] },
    { "id": "r2", "waypoints": [{ "x": 12, "y": 4 }, { "x": 16, "y": 8 }] }
  ],
  "obstacles": [
    { "x": 6, "y": 3, "w": 2, "h": 6, "type": "wall" },
    { "x": 10, "y": 8, "w": 3, "h": 2, "type": "crate" },
    { "x": 4, "y": 10, "w": 4, "h": 1, "type": "water" }
  ],
  "winCondition": { "type": "eliminate", "value": 2 },
  "loseCondition": { "type": "playerDown", "value": 0 }
}
```

### アイテム/パワーアップ（TBD）
- ドロップ条件
- 効果（攻撃力/速度/防御/スコア）
- 持続時間/スタック

### UI/スコア表示（TBD）
- HP/残機/スコア/タイマー
- ミニマップ/レーダー
- ポーズ/メニュー

### サウンド/演出（TBD）
- BGM/SE
- 被弾/爆発/勝利演出
- 画面効果（シェイク/パーティクル）

## 戦闘/物理の暫定仕様（実装参照用）
> 調査が完了するまでの暫定仕様。エンジン非依存の定義として、単位は「タイル（tile）」と「秒（s）」で記載する。

### 移動/旋回/反動
- 移動速度: 3.5 tile/s。
- 旋回速度: 180°/s（砲塔と車体を同一回転として扱う）。
- 加速/減速: 0.15 s で最高速度に到達、停止は 0.1 s。
- 反動: 発射時に車体が砲塔方向と逆に 0.2 tile/s の瞬間速度を 0.1 s 付与。

### 射撃/弾速/リロード
- 射撃間隔: 0.45 s（連射可能間隔）。
- リロード: マガジン 5 発、空撃ち後のリロード 2.0 s。
- 弾速: 12 tile/s。
- 弾の寿命: 2.5 s（寿命超過で消滅）。

### 障害物との衝突仕様
- タンク vs 障害物: タンクは円形当たり判定、障害物は矩形。押し戻しベースで衝突解決。
- 滑り: 障害物に接触した場合、進行方向の法線成分を打ち消して接線方向に滑る。
- 侵入許可: 障害物は完全に侵入不可（すり抜けなし）。
- 弾 vs 障害物: 弾は障害物に当たると即時消滅、ダメージは与えない。

## 当たり判定/ダメージ/無敵時間の暫定仕様
> エンジン依存しない形で定義する。座標は 2D 平面を想定。

### 当たり判定形状
- タンク: 半径 0.45 tile の円形コライダー。
- 弾: 半径 0.12 tile の円形コライダー。
- 障害物: 軸平行矩形（AABB）。
- 爆発範囲: 半径 1.0 tile の円形。

### ダメージ計算
- 直撃弾: 1.0 ダメージ（単位は HP）。
- 爆発ダメージ: 爆心からの距離 d に応じて線形減衰。
  - 係数: damage = max(0, 0.8 * (1 - d / 1.0))。
- 直撃と爆発が同時に発生する場合: 直撃優先、爆発ダメージは無視。

### 無敵時間（i-frame）
- 被弾後の無敵時間: 0.6 s。
- 無敵中は被弾判定のみ無効化し、衝突判定は通常通り行う。

### 爆発範囲
- 爆発は弾着弾時に発生。
- 爆発判定は 1 フレームのみ有効とし、持続ダメージは与えない。
- 爆発でノックバックは発生させない（反動は射撃のみ）。

## MVPで再現する範囲（暫定）
> 公式情報の確認後に確定する。現状は仮の空欄。

- TBD（調査完了後に、最小構成として再現する要素を記載）

## 拡張機能（暫定）
> 公式情報の確認後に確定する。現状は仮の空欄。

- TBD（調査完了後に、MVP外の追加要素を記載）
